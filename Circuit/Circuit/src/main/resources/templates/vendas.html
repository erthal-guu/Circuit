<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head.html :: head(titulo = 'Gerenciamento de Vendas')}">
</head>
<body>
<div class="container">
    <div th:replace="~{fragments/menu :: sidebar('vendas')}"></div>

    <main class="main-content">
        <header th:replace="~{fragments/header.html :: header}" class="top-bar"></header>

        <div class="content">

            <div class="content">
                <div th:if="${mensagemSucesso}" class="auto-close" style="background: #d1fae5; color: #059669; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #a7f3d0; display: flex; align-items: center; gap: 10px;">
                    <span>‚úÖ</span>
                    <span th:text="${mensagemSucesso}"></span>
                </div>
                <div th:if="${mensagemDelete}" class="auto-close" style="background: #FFFFE0; color: goldenrod; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid yellow; display: flex; align-items: center; gap: 10px;">
                    <span>üóëÔ∏è</span>
                    <span th:text="${mensagemDelete}"></span>
                </div>

                <div th:if="${mensagemErro}" class="auto-close" style="background: #fee2e2; color: #dc2626; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fca5a5; display: flex; align-items: center; gap: 10px;">
                    <span>‚ö†Ô∏è</span>
                    <span th:text="${mensagemErro}"></span>
                </div>

                <div class="page-header">
                    <h1 class="page-title">Vendas</h1>
                    <div class="header-actions">
                        <div class="tab-container">
                            <button class="tab-btn active" onclick="switchTab('todas', event)">Todas</button>
                            <button class="tab-btn" onclick="switchTab('pendentes', event)">Pendentes</button>
                            <button class="tab-btn" onclick="switchTab('concluidas', event)">Conclu√≠das</button>
                        </div>

                        <button class="btn-primary" onclick="abrirModalNovaVenda()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Nova Venda
                        </button>
                    </div>
                </div>

                <div id="tabTodas" class="tab-content active">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Todas as Vendas</h3>
                            <div class="search-box">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <input type="text" id="searchTodas" placeholder="Buscar em todas...">
                            </div>
                        </div>

                        <table class="data-table" id="tabelaTodas">
                            <thead>
                            <tr>
                                <th>ID Venda</th>
                                <th>Cliente</th>
                                <th>Itens</th>
                                <th>Respons√°vel</th>
                                <th>Data</th>
                                <th>Valor total</th>
                                <th>A√ß√µes</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="venda : ${listaTodasVendas}">
                                <td><strong th:text="'#' + ${venda.id}"></strong></td>
                                <td th:text="${venda.cliente?.nome}"></td>
                                <td th:text="${venda.itens?.size() ?: 0}"></td>
                                <td th:text="${venda.funcionario?.nome}"></td>
                                <td th:text="${#temporals.format(venda.dataVenda, 'dd/MM/yyyy')}"></td>
                                <td th:text="'R$ ' + ${#numbers.formatDecimal(venda.valorTotal, 1, 2)}"></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-edit" type="button"
                                                th:data-id="${venda.id}"
                                                th:data-cliente="${venda.cliente?.id}"
                                                th:data-valor-bruto="${venda.valorTotal}"
                                                th:data-porcentagem="${venda.porcentagemDesconto}"
                                                th:data-motivo="${venda.motivoDesconto}"
                                                th:data-valor-liquido="${venda.valorTotal}"
                                                onclick="abrirModalEdicao(this)">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                        <button class="btn-action" type="button" title="Mudar Status"
                                                th:data-id="${venda.id}"
                                                th:data-status="${venda.status}"
                                                onclick="abrirModalStatus(this.getAttribute('data-id'), this.getAttribute('data-status'))">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M23 4v6h-6"></path>
                                                <path d="M1 20v-6h6"></path>
                                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(listaTodasVendas)}">
                                <td colspan="9" style="text-align: center; padding: 20px;">Nenhuma venda encontrada.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="tabPendentes" class="tab-content" style="display: none;">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Vendas Pendentes</h3>
                            <div class="search-box">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                <input type="text" id="searchPendentes" placeholder="Buscar pendentes...">
                            </div>
                        </div>
                        <table class="data-table" id="tabelaPendentes">
                            <thead>
                            <tr>
                                <th>ID Venda</th>
                                <th>Cliente</th>
                                <th>Itens</th>
                                <th>Respons√°vel</th>
                                <th>Data</th>
                                <th>Valor total</th>
                                <th>A√ß√µes</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="venda : ${listaVendasPendentes}">
                                <td><strong th:text="'#' + ${venda.id}"></strong></td>
                                <td th:text="${venda.cliente?.nome}"></td>
                                <td th:text="${venda.itens?.size() ?: 0}"></td>
                                <td th:text="${venda.funcionario?.nome}"></td>
                                <td th:text="${#temporals.format(venda.dataVenda, 'dd/MM/yyyy')}"></td>
                                <td th:text="'R$ ' + ${#numbers.formatDecimal(venda.valorTotal, 1, 2)}"></td>
                                <td th:text="${venda.porcentagemDesconto > 0 ? '-' + venda.porcentagemDesconto + '%' : 'R$ 0,00'}"></td>
                                <td th:text="'R$ ' + ${#numbers.formatDecimal(venda.valorTotal, 1, 2)}"></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-edit" type="button"
                                                th:data-id="${venda.id}"
                                                th:data-cliente="${venda.cliente?.id}"
                                                th:data-valor-bruto="${venda.valorTotal}"
                                                th:data-porcentagem="${venda.porcentagemDesconto}"
                                                th:data-motivo="${venda.motivoDesconto}"
                                                th:data-valor-liquido="${venda.valorTotal}"
                                                onclick="abrirModalEdicao(this)">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                        <button class="btn-action" type="button" title="Mudar Status"
                                                th:data-id="${venda.id}"
                                                th:data-status="${venda.status}"
                                                onclick="abrirModalStatus(this.getAttribute('data-id'), this.getAttribute('data-status'))">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M23 4v6h-6"></path>
                                                <path d="M1 20v-6h6"></path>
                                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(listaVendasPendentes)}"><td colspan="9" style="text-align: center; padding: 20px;">Nenhuma venda pendente.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="tabConcluidas" class="tab-content" style="display: none;">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Vendas Conclu√≠das</h3>
                            <div class="search-box">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                <input type="text" id="searchConcluidas" placeholder="Buscar conclu√≠das...">
                            </div>
                        </div>
                        <table class="data-table" id="tabelaConcluidas">
                            <thead>
                            <tr>
                                <th>ID Venda</th>
                                <th>Cliente</th>
                                <th>Itens</th>
                                <th>Respons√°vel</th>
                                <th>Data</th>
                                <th>Valor total</th>
                                <th>A√ß√µes</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="venda : ${listaVendasConcluidas}">
                                <td><strong th:text="'#' + ${venda.id}"></strong></td>
                                <td th:text="${venda.cliente?.nome}"></td>
                                <td th:text="${venda.itens?.size() ?: 0}"></td>
                                <td th:text="${venda.funcionario?.nome}"></td>
                                <td th:text="${#temporals.format(venda.dataVenda, 'dd/MM/yyyy')}"></td>
                                <td th:text="'R$ ' + ${#numbers.formatDecimal(venda.valorTotal, 1, 2)}"></td>
                                <td th:text="${venda.porcentagemDesconto > 0 ? '-' + venda.porcentagemDesconto + '%' : 'R$ 0,00'}"></td>
                                <td th:text="'R$ ' + ${#numbers.formatDecimal(venda.valorTotal, 1, 2)}"></td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(listaVendasConcluidas)}"><td colspan="9" style="text-align: center; padding: 20px;">Nenhuma venda conclu√≠da.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>


        <div class="modal" id="modalNovaVenda">
            <div class="modal-content" style="max-width: 600px; margin-top: 10px">
                <div class="modal-header">
                    <h2 id="modalTitle">Nova Venda</h2>
                    <button class="close-btn" onclick="closeModalVenda()">&times;</button>
                </div>

                <form id="formVenda" th:action="@{/vendas/cadastrar}" method="POST">
                    <input type="hidden" id="vendaId" name="id">
                    <input type="hidden" name="status" value="PENDENTE">
                    <input type="hidden" id="valorBruto" value="0">
                    <input type="hidden" id="porcentagemDesconto" name="porcentagemDesconto" value="0">
                    <input type="hidden" id="motivoDesconto" name="motivoDesconto">
                    <input type="hidden" id="dataVenda" name="dataVenda">
                    <input type="hidden" id="codigo" name="codigo">
                    <input type="hidden" id="itensId" name="itensId">
                    <input type="hidden" id="quantidadeItens" name="quantidadeItens">

                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-group col-12">
                                <label>Cliente</label>
                                <select id="vendaCliente" name="clienteId" class="form-control" required>
                                    <option value="" disabled selected>Selecione o Cliente...</option>
                                    <option th:each="cli : ${listaClientes}" th:value="${cli.id}" th:text="${cli.nome}"></option>
                                </select>
                            </div>

                            <div class="form-group col-12">
                                <label>Respons√°vel</label>
                                <select id="vendaFuncionario" name="funcionarioId" class="form-control" required>
                                    <option value="">Selecione o Respons√°vel...</option>
                                    <option th:each="func : ${listaFuncionarios}" th:value="${func.id}" th:text="${func.nome}"></option>
                                </select>
                            </div>

                            <div class="form-group col-12">
                                <label>Forma de Pagamento</label>
                                <select id="formaPagamento" name="formaPagamento" class="form-control" required onchange="handleFormaPagamentoChange()">
                                    <option value="" disabled selected>Selecione a forma de pagamento...</option>
                                    <option th:each="forma : ${T(Circuit.Circuit.Model.FormaPagamento).values()}" th:value="${forma}" th:text="${forma.descricao}"></option>
                                </select>
                            </div>

                            <div class="form-group col-12" id="condicaoPagamentoContainer" style="display: none; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease;">
                                <label>Condi√ß√£o de Pagamento</label>
                                <div class="tab-pill-container" style="background: rgba(0, 0, 0, 0.05); padding: 2px; border-radius: 50px; display: inline-flex;">
                                    <input type="radio" id="condicaoAVista" name="condicaoPagamento" value="AVISTA" checked onchange="handleCondicaoPagamentoChange()">
                                    <label for="condicaoAVista" id="labelCondicaoAVista" style="color: #64748b;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                                            <line x1="2" y1="10" x2="22" y2="10"></line>
                                        </svg>
                                        <span>A Vista</span>
                                    </label>
                                    <input type="radio" id="condicaoParcelado" name="condicaoPagamento" value="PARCELADO" onchange="handleCondicaoPagamentoChange()">
                                    <label for="condicaoParcelado" id="labelCondicaoParcelado" style="color: #64748b;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                                            <line x1="2" y1="10" x2="22" y2="10"></line>
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                        </svg>
                                        <span>Parcelado</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group col-12" id="parcelasContainer" style="display: none;">
                                <label>N√∫mero de Parcelas</label>
                                <select id="parcelas" name="numeroParcelas" class="form-control">
                                    <option value="1">1x</option>
                                    <option value="2">2x</option>
                                    <option value="3">3x</option>
                                    <option value="4">4x</option>
                                    <option value="5">5x</option>
                                    <option value="6">6x</option>
                                    <option value="7">7x</option>
                                    <option value="8">8x</option>
                                    <option value="9">9x</option>
                                    <option value="10">10x</option>
                                    <option value="11">11x</option>
                                    <option value="12">12x</option>
                                </select>
                            </div>

                            <div class="form-group col-12">
                                <label>Itens da Venda</label>
                                <div id="listaItensVenda" class="itens-venda-list" style="display: none;"></div>
                                <button type="button" class="btn-secondary" onclick="abrirModalAdicionarItens()" style="background: linear-gradient(135deg, #001d3d 0%, #003366 100%); margin-top: 10px; width: 100%; color: white; border: none; padding: 12px 20px; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 29, 62, 0.1);" onmouseover="this.style.background='linear-gradient(135deg, #003366 0%, #0056b3 100%)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0, 29, 62, 0.2)';" onmouseout="this.style.background='linear-gradient(135deg, #001d3d 0%, #003366 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0, 29, 62, 0.1)';">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Adicionar produtos
                                </button>
                            </div>

                            <div class="financial-summary col-12">
                                <div class="fin-item">
                                    <label><span>Valor Bruto (R$)</span></label>
                                    <input type="number" id="valorBrutoInput" name="valorBruto" class="form-control" step="0.01" value="0.00" readonly>
                                </div>

                                <div class="fin-item total">
                                    <label><span>Valor Total (R$)</span></label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="number" id="valorTotal" name="valorTotal" class="form-control" step="0.01" readonly>
                                        <button type="button" class="btn-discount" onclick="abrirModalDesconto()" title="Aplicar Desconto">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="19" y1="5" x2="5" y2="19"></line>
                                                <circle cx="6.5" cy="6.5" r="2.5"></circle>
                                                <circle cx="17.5" cy="17.5" r="2.5"></circle>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeModalVenda()">Cancelar</button>
                        <button type="submit" class="btn-submit">Salvar Venda</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal" id="modalDesconto" style="background: rgba(0,0,0,0.3);">
            <div class="modal-content" style="max-width: 400px; margin-top: 100px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <div class="modal-header">
                    <h3 class="title-atualizar">Aplicar Desconto</h3>
                    <button type="button" class="close-btn" onclick="fecharModalDesconto()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Porcentagem</label>
                        <input type="text" id="inputPorcentagem" name="porcentagemDesconto" class="form-control" placeholder="Ex: 10%" required onfocus="removerPorcentagem(this)" onchange="adicionarPorcentagem(this)" maxlength="4">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Motivo do Desconto</label>
                        <textarea id="inputMotivo" class="form-control" rows="3" placeholder="Ex: Cliente fidelidade, Black Friday..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="fecharModalDesconto()">Cancelar</button>
                    <button type="button" class="btn-primary" onclick="confirmarDesconto()">Aplicar</button>
                </div>
            </div>
        </div>

        <div class="modal" id="modalStatus">
            <div class="modal-content" style="max-width: 550px; padding: 0;">

                <div class="modal-header" style="border-bottom: 1px solid #eee; padding: 20px;">
                    <div style="width: 100%;">
                        <h2 class="title-atualizar">Atualizar Status da Venda</h2>
                        <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 0.9rem; color: #64748b;">Status atual:</span>
                            <span id="badgeStatusAtual" class="badge">Carregando...</span>
                        </div>
                    </div>
                    <button class="close-btn" onclick="fecharModalStatus()" style="align-self: flex-start;">&times;</button>
                </div>

                <form id="formStatus" th:action="@{/vendas/atualizar-status}" method="POST">
                    <input type="hidden" id="statusVendaId" name="id">
                    <input type="hidden" id="novoStatus" name="status">

                    <div class="modal-body" style="padding: 20px; background: #f8fafc;">
                        <div class="status-grid">

                            <div class="status-card" onclick="selecionarStatus('PENDENTE')">
                                <div class="icon-circle info">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                </div>
                                <span>Pendente</span>
                            </div>

                            <div class="status-card" onclick="selecionarStatus('EM_PROCESSAMENTO')">
                                <div class="icon-circle warning">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                </div>
                                <span>Em Processamento</span>
                            </div>

                            <div class="status-card" onclick="selecionarStatus('CONCLUIDA')">
                                <div class="icon-circle success">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                </div>
                                <span>Conclu√≠da</span>
                            </div>

                            <div class="status-card danger-card" onclick="selecionarStatus('CANCELADA')">
                                <div class="icon-circle danger">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </div>
                                <span>Cancelada</span>
                            </div>

                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal" id="modalAdicionarItensVenda" style="background: rgba(0,0,0,0.3);">
            <div class="modal-content" style="max-width: 600px; margin-top: 100px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <div class="modal-header">
                    <h3 class="title-atualizar">Adicionar Itens √† Venda</h3>
                    <button type="button" class="close-btn" onclick="fecharModalAdicionarItens()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="tbodyModalItensVenda" class="checkbox-grid-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px;">
                        <div style="text-align: center; padding: 20px;">Carregando produtos...</div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Itens selecionados: <strong id="countSelecionadosVenda">0</strong></span>
                            <span>Subtotal: <strong id="subtotalModalVenda">R$ 0,00</strong></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="fecharModalAdicionarItens()">Cancelar</button>
                    <button type="button" class="btn-primary" onclick="adicionarItensSelecionados()">Adicionar</button>
                </div>
            </div>
        </div>

        <script th:src="@{/js/venda.js}"></script>
    </main>
</div>
</body>
</html>