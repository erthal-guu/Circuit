<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head.html :: head(titulo = 'Pedidos de Compra')}">
</head>
<body>

<div th:replace="~{fragments/menu :: sidebar('pedidos')}"></div>

<div class="main-content">
    <header th:replace="~{fragments/header :: header}"></header>

    <div class="content">
        <div class="content">
            <div th:if="${mensagemSucesso}" class="auto-close" style="background: #d1fae5; color: #059669; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #a7f3d0; display: flex; align-items: center; gap: 10px;">
                <span>✅</span>
                <span th:text="${mensagemSucesso}"></span>
            </div>

            <div th:if="${mensagemErro}" class="alert alert-danger"
                 style="padding: 15px; background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; border-radius: 8px; margin-bottom: 20px;">
                <span th:text="${mensagemErro}"></span>
            </div>
        <div class="page-header">
            <div>
                <h1 class="page-title" id="main-title">Pedidos</h1>
            </div>
            <div class="header-actions">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('lista')" id="btn-tab-lista">
                        Meus Pedidos
                    </button>
                    <button class="tab-btn" onclick="switchTab('form')" id="btn-tab-form">
                        Novo Pedido
                    </button>
                </div>

                <button type="submit" form="formPedido" id="btn-salvar-global" class="btn-primary btn-block justify-center" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Salvar Pedido
                </button>
            </div>
        </div>

        <div id="view-lista" class="tab-view">
            <div class="table-card">
                <div class="table-header">
                    <h3>Histórico de Pedidos</h3>
                    <div class="search-box">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" placeholder="Pesquisar pedidos...">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Cód.</th>
                            <th>Fornecedor</th>
                            <th>Data</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th class="text-center">Ações</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="pedido : ${listaPedidos}">
                            <td th:text="${pedido.codigo}" class="font-700"></td>
                            <td th:text="${pedido.fornecedor.nomeFantasia}"></td>
                            <td th:text="${#temporals.format(pedido.dataPedido, 'dd/MM/yyyy')}"></td>
                            <td th:text="${#numbers.formatCurrency(pedido.valorTotal)}"></td>
                            <td>
        <span class="badge"
              th:classappend="${
                  pedido.status.name() == 'PENDENTE' ? 'badge-analysis' :
                  (pedido.status.name() == 'CONFIRMADO' ? 'badge-active' :
                  (pedido.status.name() == 'RECEBIDO' ? 'badge-success' : 'badge-inactive'))
              }"
              th:text="${pedido.status}">PENDENTE</span>
                            </td>
                            <td class="text-center">
                                <div class="action-buttons">
                                    <button class="btn-action" type="button" title="Mudar Status"
                                            th:data-id="${pedido.id}"
                                            th:data-status="${pedido.status}"
                                            onclick="abrirModalStatus(this.getAttribute('data-id'), this.getAttribute('data-status'))">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path>
                                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                        </svg>
                                    </button>

                                    <button class="btn-action btn-edit" title="Detalhes"
                                            th:data-id="${pedido.id}"
                                            th:data-codigo="${pedido.codigo}"
                                            th:data-fornecedor="${pedido.fornecedor.nomeFantasia}"
                                            th:data-responsavel="${pedido.responsavel.nome}"
                                            th:data-tipo="${pedido.tipoPedido}"
                                            th:data-status="${pedido.status}"
                                            th:data-data="${#temporals.format(pedido.dataPedido, 'dd/MM/yyyy')}"
                                            th:data-total="${#numbers.formatCurrency(pedido.valorTotal)}"
                                            th:data-obs="${pedido.observacoes}"
                                            onclick="verDetalhes(this)"
                                            style="background: #e0f2fe; color: #0369a1;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="8" y1="6" x2="21" y2="6"></line>
                                            <line x1="8" y1="12" x2="21" y2="12"></line>
                                            <line x1="8" y1="18" x2="21" y2="18"></line>
                                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-form" class="tab-view" style="display: none;">
            <form th:action="@{/pedidos/salvar}" method="POST" id="formPedido" class="w-100">

                <div class="table-card p-25">
                    <div class="status-header flex-between">
                        <h3>Dados Gerais</h3>

                        <div class="tab-pill-container">
                            <input type="radio" id="tipoPeca" name="tipoPedido" value="PECA" checked onchange="filtrarFornecedores()">
                            <label for="tipoPeca">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></svg>
                                Peças
                            </label>

                            <input type="radio" id="tipoProduto" name="tipoPedido" value="PRODUTO" onchange="filtrarFornecedores()">
                            <label for="tipoProduto">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                                Produtos
                            </label>
                        </div>
                    </div>

                    <div class="form-grid-4">
                        <div class="form-group">
                            <label>Número do Pedido</label>
                            <div class="input-wrapper-btn">
                                <input type="text" id="numeroPedido" name="numeroPedido" class="form-control input-readonly" readonly>
                                <button type="button" class="btn-inside" onclick="gerarCodigoHex()" title="Gerar código">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"/><path d="m18 2 4 4-4 4"/><path d="M2 6h1.9c1.5 0 2.7.9 3.6 2.2"/><path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"/><path d="m18 14 4 4-4 4"/></svg>
                                </button>
                            </div>
                        </div>

                        <div class="form-group span-2">
                            <label>Fornecedor <span class="text-danger"></span></label>
                            <select class="form-control text-main" id="selectFornecedor" name="fornecedorId" required onchange="atualizarDadosFornecedor(this)">
                                <option value="" disabled selected>Selecione...</option>
                                <option th:each="f : ${listaFornecedores}"
                                        th:value="${f.id}"
                                        th:text="${f.nomeFantasia + ' - ' +f.cep + ' - '+ f.estado}"
                                        th:data-cnpj="${f.cnpj}"
                                        th:data-tipo="${f.tipo}"
                                        th:data-nome="${f.nomeFantasia}">
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>CNPJ / Cód.</label>
                            <input type="text" id="inputCnpjFornecedor" class="form-control input-bg" readonly>
                        </div>

                        <div class="form-group">
                            <label>Data Pedido</label>
                            <input type="date" class="form-control" name="dataPedido" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required>
                        </div>

                        <div class="form-group">
                            <label>Responsável</label>
                            <select class="form-control" name="responsavelId" id="selectResponsavel">
                                <option value="" disabled selected>Selecione...</option>
                                <option th:each="func : ${listaFuncionarios}" th:value="${func.id}" th:text="${func.nome}"></option>
                            </select>
                        </div>

                        <div class="form-group span-3">
                            <label>Observações para o Fornecedor</label>
                            <textarea class="form-control"
                                      name="observacao"
                                      style="height: 40px; resize: none; margin-top: 1px; line-height: 1.5; "></textarea>
                        </div>
                        <div class="form-group span-1">
                            <label class="text-primary font-700">Total do Pedido</label>
                            <div>
                                <input type="text" id="spanTotalFinal" name="valorTotal" class="input-money-wrapper   " value="0,00" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-card mt-20">
                    <div class="card-header-simple">
                        <h3 class="flex-center gap-5 text-white">Itens do Pedido</h3>
                        <button type="button" class="btn-primary flex-center gap-5" onclick="abrirModalAdicionarItens()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Adicionar item
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table" id="tabelaItens">
                            <thead>
                            <tr>
                                <th style="width: 40%">Item</th>
                                <th>Qtd.</th>
                                <th>Valor Unit.</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody id="tbodyItens">
                            </tbody>
                        </table>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="modalItemPedido" class="modal" style="display: none;">
    <div class="modal-content-lg">
        <div class="modal-header-erp modal-header-lg">
            <div>
                <h3>Adicionar Itens ao Pedido</h3>
                <p id="fornecedorNome">Fornecedor: </p>
            </div>
            <button type="button" class="close-btn" onclick="fecharModal()">&times;</button>
        </div>

        <div class="modal-body-scroll">
            <table class="modal-table">
                <thead>
                <tr>
                    <th class="text-center">Sel.</th>
                    <th>Item</th>
                    <th>Preço Unit.</th>
                    <th>Qtd.</th>
                </tr>
                </thead>
                <tbody id="tbodyModalItens">
                </tbody>
            </table>
        </div>

        <div class="modal-footer-erp">
            <div class="footer-info">
                <div class="info-box">
                    <span class="label">Selecionados</span>
                    <span id="countSelecionados" class="value">0</span>
                </div>
                <div class="info-box">
                    <span class="label">Subtotal Estimado</span>
                    <span id="subtotalModal" class="value-lg">R$ 0,00</span>
                </div>
            </div>
            <div class="footer-btns">
                <button type="button" class="btn-cancel" onclick="fecharModal()">Cancelar</button>
                <button type="button" class="btn-confirm" onclick="adicionarSelecionados()">Confirmar Itens</button>
            </div>
        </div>
    </div>
</div>
</div>
<div class="modal" id="modalStatus">
    <div class="modal-content" style="max-width: 550px; padding: 0;">
        <div class="modal-header" style="border-bottom: 1px solid #eee; padding: 20px;">
            <div style="width: 100%;">
                <h2 class="title-atualizar">Atualizar Status do Pedido</h2>
                <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.9rem; color: #64748b;">Status atual:</span>
                    <span id="badgeStatusAtual" class="badge">Carregando...</span>
                </div>
            </div>
            <button class="close-btn" onclick="fecharModalStatus()">&times;</button>
        </div>

        <form id="formStatus" th:action="@{/pedidos/atualizar-status}" method="POST">
            <input type="hidden" id="statusPedidoId" name="pedidoId">
            <input type="hidden" id="novoStatusInput" name="novoStatus">

            <div class="modal-body" style="padding: 20px; background: #f8fafc;">
                <div class="status-grid">

                    <div class="status-card" onclick="selecionarStatus('PENDENTE')">
                        <div class="icon-circle info">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </div>
                        <span>Pendente</span>
                    </div>

                    <div class="status-card" onclick="selecionarStatus('CONFIRMADO')">
                        <div class="icon-circle success">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </div>
                        <span>Confirmado</span>
                    </div>

                    <div class="status-card" onclick="selecionarStatus('RECEBIDO')">
                        <div class="icon-circle purple">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h4l2 3h3a2 2 0 0 1 2 2z"></path></svg>
                        </div>
                        <span>Recebido</span>
                    </div>

                    <div class="status-card danger-card" onclick="selecionarStatus('CANCELADO')">
                        <div class="icon-circle danger">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                        <span>Cancelar Pedido</span>
                    </div>

                </div>
            </div>
        </form>
    </div>
</div>
<div id="modalDetalhes" class="modal">
    <div class="modal-content-lg" style="max-width: 850px;">
        <div class="modal-header-erp">
            <div>
                <h3 id="det-codigo">PEDIDO #0000</h3>
                <p id="det-fornecedor">FORNECEDOR: ...</p>
            </div>
            <button type="button" class="close-btn" onclick="fecharModalDetalhes()">&times;</button>
        </div>

        <div class="modal-body" style="padding: 25px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <div>
                    <label style="display:block; font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase;">Data de Emissão</label>
                    <span id="det-data" class="font-600"></span>
                </div>
                <div>
                    <label style="display:block; font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase;">Responsável</label>
                    <span id="det-responsavel" class="font-600"></span>
                </div>
                <div>
                    <label style="display:block; font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase;">Tipo</label>
                    <span id="det-tipo" class="font-600"></span>
                </div>
                <div>
                    <label style="display:block; font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase;">Status</label>
                    <div id="det-status-badge"></div>
                </div>
            </div>

            <h4 style="margin-bottom: 12px; color: #001d3d; border-left: 4px solid var(--primary-color); padding-left: 10px;">Itens do Pedido</h4>
            <div class="table-responsive" style="max-height: 300px; border: 1px solid #e2e8f0; border-radius: 8px;">
                <table class="data-table">
                    <thead>
                    <tr style="background: #f1f5f9;">
                        <th class="text-center">Qtd</th>
                        <th>Valor Unit.</th>
                        <th>Subtotal</th>
                    </tr>
                    </thead>
                    <tbody id="det-tbody-itens">
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px;">
                <label style="display:block; font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 5px;">Observações do Fornecedor</label>
                <div id="det-obs" style="padding: 12px; background: #fffbeb; border: 1px solid #fef3c7; border-radius: 6px; font-size: 13px; color: #92400e; min-height: 50px;"></div>
            </div>
        </div>

        <div class="modal-footer-erp">
            <div style="text-align: right;">
                <span style="font-size: 12px; color: #64748b; font-weight: 600; display: block; margin-bottom: 5px;">VALOR TOTAL DO PEDIDO</span>
                <span id="det-total" style="font-size: 1.8rem; font-weight: 800; color: #001d3d;">R$ 0,00</span>
            </div>
            <button type="button" class="btn-cancel" onclick="fecharModalDetalhes()">Fechar Documento</button>
        </div>
    </div>
</div>

<script th:src="@{/js/pedido.js}"></script>
</body>
</html>